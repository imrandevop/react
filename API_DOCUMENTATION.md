# API Documentation

## Base URL
```
http://your-domain.com/api/
```

## Authentication
Most endpoints require a JWT Bearer token in the Authorization header:
```
Authorization: Bearer <access_token>
```

---

## Table of Contents
1. [Authentication APIs](#authentication-apis)
2. [Post Management APIs](#post-management-apis)
3. [Feed APIs](#feed-apis)
4. [Voting APIs](#voting-apis)
5. [Comment APIs](#comment-apis)
6. [Report APIs](#report-apis)
7. [Storage APIs](#storage-apis)
8. [Account Management APIs](#account-management-apis)

---

## Authentication APIs

### 1. Login / Register
**Endpoint:** `POST /api/auth/login`

**Description:** Login or register a user. If the user doesn't exist, a new account is created automatically.

**Authentication:** Not required

**Request Body:**
```json
{
  "localBody": "Kozhikode",
  "pincode": "673001",
  "userId": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Request Fields:**
- `localBody` (string, required): The local body/area name
- `pincode` (string, required): 6-digit pincode
- `userId` (UUID string, required): Unique user identifier (generated by client)

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": {
    "token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "user": {
      "id": "1",
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "localBody": "Kozhikode",
      "pincode": "673001"
    }
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "status": 400,
  "data": {
    "message": "Login Failed",
    "errors": {
      "localBody": ["This field is required."]
    }
  }
}
```

---

## Post Management APIs

### 2. Create Post
**Endpoint:** `POST /api/posts/`

**Description:** Create a new post with images (supports both file upload and Supabase URLs)

**Authentication:** Required

**Request Body (Multipart Form Data):**
```
category: "PROBLEM"
headline: "Road damaged near market"
description: "The main road near the central market has large potholes causing traffic issues."
images: [file1.jpg, file2.jpg]  // Optional if using image_urls
```

**OR (JSON with Supabase URLs):**
```json
{
  "category": "PROBLEM",
  "headline": "Road damaged near market",
  "description": "The main road near the central market has large potholes causing traffic issues.",
  "image_urls": [
    "https://your-supabase-url.com/storage/v1/object/public/bucket/file1.jpg",
    "https://your-supabase-url.com/storage/v1/object/public/bucket/file2.jpg"
  ]
}
```

**Request Fields:**
- `category` (string, required): One of: `NEWS`, `UPDATE`, `PROBLEM`, `ADVERTISEMENT`
- `headline` (string, optional): Post title/headline
- `description` (string, required): Post content
- `images` (array of files, optional): Image files to upload
- `image_urls` (array of strings, optional): Supabase image URLs (alternative to file upload)

**Note:** For `PROBLEM` category, at least one image (either file or URL) is required.

**Success Response (201 Created):**
```json
{
  "status": 201,
  "data": {
    "id": 1,
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "headline": "Road damaged near market",
    "imageUrls": [
      "http://localhost:8000/media/post_images/file1.jpg",
      "http://localhost:8000/media/post_images/file2.jpg"
    ],
    "description": "The main road near the central market has large potholes causing traffic issues.",
    "category": "PROBLEM",
    "upvotes": 0,
    "downvotes": 0,
    "commentsCount": 0,
    "created_at": "2025-12-26T06:20:30.123456Z",
    "hasUpvoted": false,
    "hasDownvoted": false
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "status": 400,
  "message": "Failed to create post",
  "errors": {
    "images": ["At least one image is required for PROBLEM category."]
  }
}
```

---

### 3. Update Post
**Endpoint:** `PUT /api/posts/{postId}/` or `PATCH /api/posts/{postId}/`

**Description:** Update an existing post (only by post owner or admin)

**Authentication:** Required

**Request Body:** Same as Create Post (all fields optional for PATCH)

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": {
    "id": 1,
    "userId": "550e8400-e29b-41d4-a716-446655440000",
    "headline": "Updated headline",
    "imageUrls": ["..."],
    "description": "Updated description",
    "category": "PROBLEM",
    "upvotes": 5,
    "downvotes": 1,
    "commentsCount": 3,
    "created_at": "2025-12-26T06:20:30.123456Z",
    "hasUpvoted": true,
    "hasDownvoted": false
  }
}
```

**Error Response (403 Forbidden):**
```json
{
  "status": 403,
  "message": "Permission denied"
}
```

---

### 4. Delete Post
**Endpoint:** `DELETE /api/posts/{postId}/`

**Description:** Delete a post (only by post owner or admin)

**Authentication:** Required

**Success Response (200 OK):**
```json
{
  "status": 200,
  "message": "Post deleted successfully"
}
```

**Error Response (403 Forbidden):**
```json
{
  "status": 403,
  "message": "Permission denied"
}
```

---

### 5. List Posts
**Endpoint:** `GET /api/posts/`

**Description:** Get a paginated list of posts (basic listing, prefer using `/api/feed` for main feed)

**Authentication:** Required

**Query Parameters:**
- `page` (integer, optional): Page number (default: 1)
- `limit` (integer, optional): Items per page (default: 20, max: 100)
- `filter` (string, optional): One of: `TODAY`, `PROBLEMS`, `UPDATES`, `YOURS`, `ALL`

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": [
    {
      "id": 1,
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "headline": "Road issue",
      "imageUrls": ["..."],
      "description": "Description",
      "category": "PROBLEM",
      "upvotes": 5,
      "downvotes": 1,
      "commentsCount": 3,
      "created_at": "2025-12-26T06:20:30.123456Z",
      "hasUpvoted": true,
      "hasDownvoted": false
    }
  ]
}
```

---

## Feed APIs

### 6. Get Feed
**Endpoint:** `GET /api/feed`

**Description:** Get the main feed with cursor-based pagination and advertisements

**Authentication:** Required

**Query Parameters:**
- `tab` (string, required): One of: `All`, `Today`, `Problems`, `Updates`, `Yours`
- `cursor` (string, optional): Pagination cursor from previous response
- `limit` (integer, optional): Items per page (default: 20, max: 100)
- `pincode` (string, optional): Filter by specific pincode (highest priority)
- `localBody` (string, optional): Filter by local body (second priority)

**Note:** If neither `pincode` nor `localBody` is provided, uses authenticated user's pincode.

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": {
    "next": "http://localhost:8000/api/feed?cursor=cD0yMDI1LTEyLTI2KzA2JTNBMjAlM0EzMC4xMjM0NTY%3D&tab=All",
    "previous": null,
    "results": [
      {
        "id": 1,
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "headline": "Road issue",
        "imageUrls": ["..."],
        "description": "Description",
        "category": "PROBLEM",
        "upvotes": 15,
        "downvotes": 2,
        "commentsCount": 8,
        "created_at": "2025-12-26T06:20:30.123456Z",
        "hasUpvoted": true,
        "hasDownvoted": false
      }
    ],
    "ads": [
      {
        "id": 10,
        "title": "Special Offer!",
        "description": "Get 50% off on all items",
        "imageUrls": ["..."],
        "buttonText": "Shop Now",
        "buttonUrl": "https://example.com/shop",
        "sponsorName": "Local Store"
      }
    ]
  }
}
```

**Tab Behavior:**
- `All`: All posts sorted by upvotes, then newest
- `Today`: Posts created today, sorted by upvotes, then newest
- `Problems`: Only PROBLEM category posts, sorted by upvotes, then newest
- `Updates`: Only UPDATE category posts, sorted by upvotes, then newest
- `Yours`: Only your posts, sorted by newest

**Error Response (400 Bad Request):**
```json
{
  "status": 400,
  "message": "Tab parameter is required"
}
```

---

### 7. Refresh Feed
**Endpoint:** `GET /api/feed/refresh`

**Description:** Get the latest posts without pagination (for pull-to-refresh)

**Authentication:** Required

**Query Parameters:**
- `tab` (string, required): One of: `All`, `Today`, `Problems`, `Updates`, `Yours`
- `pincode` (string, optional): Filter by specific pincode
- `localBody` (string, optional): Filter by local body

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": {
    "posts": [
      {
        "id": 1,
        "userId": "550e8400-e29b-41d4-a716-446655440000",
        "headline": "Road issue",
        "imageUrls": ["..."],
        "description": "Description",
        "category": "PROBLEM",
        "upvotes": 15,
        "downvotes": 2,
        "commentsCount": 8,
        "created_at": "2025-12-26T06:20:30.123456Z",
        "hasUpvoted": true,
        "hasDownvoted": false
      }
    ]
  }
}
```

**Note:** Returns maximum 20 latest posts, no pagination.

---

## Voting APIs

### 8. Upvote Post
**Endpoint:** `POST /api/posts/{postId}/upvote/`

**Description:** Upvote a post (Reddit-style: toggle if already upvoted, change if downvoted)

**Authentication:** Required

**Request Body:** None

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": {
    "upvotes": 16,
    "downvotes": 2,
    "hasUpvoted": true,
    "hasDownvoted": false
  }
}
```

**Voting Logic:**
- If not voted: Add upvote
- If already upvoted: Remove upvote (toggle)
- If downvoted: Change to upvote

**Important:** Users can vote on ANY post, including posts from different pincodes/localities (even if they're not in their feed's default view). Users can also vote on their own posts.

---

### 9. Downvote Post
**Endpoint:** `POST /api/posts/{postId}/downvote/`

**Description:** Downvote a post (Reddit-style: toggle if already downvoted, change if upvoted)

**Authentication:** Required

**Request Body:** None

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": {
    "upvotes": 15,
    "downvotes": 3,
    "hasUpvoted": false,
    "hasDownvoted": true
  }
}
```

**Voting Logic:**
- If not voted: Add downvote
- If already downvoted: Remove downvote (toggle)
- If upvoted: Change to downvote

**Important:** Users can vote on ANY post, including posts from different pincodes/localities (even if they're not in their feed's default view). Users can also vote on their own posts.

---

## Comment APIs

### 10. Get Comments
**Endpoint:** `GET /api/posts/{postId}/comments/`

**Description:** Get all comments for a post

**Authentication:** Required

**Success Response (200 OK):**
```json
[
  {
    "id": 1,
    "user": "Kozhikode",
    "userId": "1",
    "text": "This is a serious issue that needs immediate attention!",
    "created_at": "2025-12-26T06:25:30.123456Z"
  },
  {
    "id": 2,
    "user": "Kozhikode",
    "userId": "2",
    "text": "I agree, the authorities should fix this soon.",
    "created_at": "2025-12-26T06:30:15.654321Z"
  }
]
```

---

### 11. Add Comment
**Endpoint:** `POST /api/posts/{postId}/comments/`

**Description:** Add a comment to a post

**Authentication:** Required

**Request Body:**
```json
{
  "text": "This is a serious issue that needs immediate attention!"
}
```

**Request Fields:**
- `text` (string, required): Comment text (cannot be empty)

**Success Response (201 Created):**
```json
{
  "id": 1,
  "user": "Kozhikode",
  "userId": "1",
  "text": "This is a serious issue that needs immediate attention!",
  "created_at": "2025-12-26T06:25:30.123456Z"
}
```

**Error Response (400 Bad Request):**
```json
{
  "text": ["Comment text cannot be empty."]
}
```

---

### 12. Update Comment
**Endpoint:** `PUT /api/posts/{postId}/update_comment/`

**Description:** Update your own comment

**Authentication:** Required

**Request Body:**
```json
{
  "comment_id": 1,
  "text": "Updated comment text"
}
```

**Request Fields:**
- `comment_id` (integer, required): ID of the comment to update
- `text` (string, required): New comment text

**Success Response (200 OK):**
```json
{
  "id": 1,
  "user": "Kozhikode",
  "userId": "1",
  "text": "Updated comment text",
  "created_at": "2025-12-26T06:25:30.123456Z"
}
```

**Error Response (403 Forbidden):**
```json
{
  "error": "You can only edit your own comments"
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Comment not found"
}
```

---

### 13. Delete Comment
**Endpoint:** `DELETE /api/posts/{postId}/delete_comment/`

**Description:** Delete your own comment

**Authentication:** Required

**Request Body or Query Parameter:**
```json
{
  "comment_id": 1
}
```

**OR** as query parameter: `?comment_id=1`

**Success Response (200 OK):**
```json
{
  "message": "Comment deleted successfully"
}
```

**Error Response (403 Forbidden):**
```json
{
  "error": "You can only delete your own comments"
}
```

---

## Report APIs

### 14. Report Post
**Endpoint:** `POST /api/posts/{postId}/report/`

**Description:** Report a post for inappropriate content (one report per user per post)

**Authentication:** Required

**Request Body:**
```json
{
  "description": "This post contains inappropriate content"
}
```

**Request Fields:**
- `description` (string, required): Reason for reporting

**Success Response (201 Created):**
```json
{
  "status": 201,
  "data": {
    "message": "Post reported successfully",
    "report": {
      "id": 1,
      "user": "Kozhikode",
      "userId": "1",
      "description": "This post contains inappropriate content",
      "status": "PENDING",
      "created_at": "2025-12-26T06:40:30.123456Z"
    },
    "total_reports": 5
  }
}
```

**Error Response (400 Bad Request):**
```json
{
  "status": 400,
  "message": "You have already reported this post"
}
```

---

## Storage APIs

### 15. Generate Upload URL
**Endpoint:** `POST /api/storage/upload-url`

**Description:** Generate a signed URL for uploading images to Supabase Storage

**Authentication:** Required

**Request Body:**
```json
{
  "filename": "image.jpg",
  "content_type": "image/jpeg"
}
```

**Request Fields:**
- `filename` (string, required): Original filename
- `content_type` (string, optional): MIME type (default: "image/jpeg")

**Success Response (200 OK):**
```json
{
  "status": 200,
  "data": {
    "upload_url": "https://your-supabase-url.com/storage/v1/object/upload/sign/bucket/posts/abc123.jpg?token=...",
    "file_path": "posts/abc123.jpg",
    "public_url": "https://your-supabase-url.com/storage/v1/object/public/bucket/posts/abc123.jpg",
    "expires_in": 3600
  }
}
```

**Usage Flow:**
1. Request signed URL from this endpoint
2. Upload image to `upload_url` using PUT request
3. Use `public_url` in the `image_urls` array when creating/updating posts

**Error Response (400 Bad Request):**
```json
{
  "status": 400,
  "message": "filename is required"
}
```

**Error Response (500 Internal Server Error):**
```json
{
  "status": 500,
  "message": "Failed to generate upload URL: <error details>"
}
```

---

## Account Management APIs

### 16. Delete Account
**Endpoint:** `DELETE /api/auth/delete-account`

**Description:** Permanently delete user account and all associated data (posts, comments, votes, reports)

**Authentication:** Required

**Request Body:** None

**Success Response (200 OK):**
```json
{
  "status": 200,
  "message": "Account deleted successfully",
  "data": {
    "userId": "1"
  }
}
```

**Warning:** This action is irreversible and will CASCADE delete all user data.

---

## Data Models

### User
```json
{
  "id": "1",
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "localBody": "Kozhikode",
  "pincode": "673001"
}
```

### Post
```json
{
  "id": 1,
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "headline": "Road damaged near market",
  "imageUrls": ["http://localhost:8000/media/post_images/file1.jpg"],
  "description": "The main road has large potholes",
  "category": "PROBLEM",
  "upvotes": 15,
  "downvotes": 2,
  "commentsCount": 8,
  "created_at": "2025-12-26T06:20:30.123456Z",
  "hasUpvoted": true,
  "hasDownvoted": false
}
```

### Advertisement
```json
{
  "id": 10,
  "title": "Special Offer!",
  "description": "Get 50% off on all items",
  "imageUrls": ["..."],
  "buttonText": "Shop Now",
  "buttonUrl": "https://example.com/shop",
  "sponsorName": "Local Store"
}
```

### Comment
```json
{
  "id": 1,
  "user": "Kozhikode",
  "userId": "1",
  "text": "This is a comment",
  "created_at": "2025-12-26T06:25:30.123456Z"
}
```

### Report
```json
{
  "id": 1,
  "user": "Kozhikode",
  "userId": "1",
  "description": "Inappropriate content",
  "status": "PENDING",
  "created_at": "2025-12-26T06:40:30.123456Z"
}
```

---

## Enumerations

### Post Categories
- `NEWS` - News posts
- `UPDATE` - Updates about local area
- `PROBLEM` - Problem reports (requires images)
- `ADVERTISEMENT` - Sponsored advertisements

### Report Status
- `PENDING` - Awaiting review
- `REVIEWED` - Under review
- `RESOLVED` - Resolved

### Vote Types
- `1` - Upvote
- `-1` - Downvote

---

## Error Handling

All API endpoints follow a consistent error response format:

**4xx Client Errors:**
```json
{
  "status": 400,
  "message": "Error message",
  "errors": {
    "field_name": ["Error detail"]
  }
}
```

**5xx Server Errors:**
```json
{
  "status": 500,
  "message": "Internal server error message"
}
```

**Common HTTP Status Codes:**
- `200 OK` - Success
- `201 Created` - Resource created successfully
- `400 Bad Request` - Invalid request data
- `401 Unauthorized` - Missing or invalid authentication
- `403 Forbidden` - Permission denied
- `404 Not Found` - Resource not found
- `500 Internal Server Error` - Server error

---

## Pagination

### Cursor-Based Pagination (Feed APIs)
Used by `/api/feed` endpoint for better performance:

**Request:**
```
GET /api/feed?tab=All&cursor=cD0yMDI1LTEyLTI2KzA2JTNBMjAlM0EzMC4xMjM0NTY%3D&limit=20
```

**Response:**
```json
{
  "next": "http://localhost:8000/api/feed?cursor=<next_cursor>&tab=All",
  "previous": "http://localhost:8000/api/feed?cursor=<prev_cursor>&tab=All",
  "results": [...]
}
```

### Page-Based Pagination (Posts APIs)
Used by `/api/posts/` endpoint:

**Request:**
```
GET /api/posts/?page=2&limit=20
```

**Response includes:** Standard array of results with pagination metadata.

---

## Rate Limiting

Currently no rate limiting is implemented. Consider implementing rate limiting in production to prevent abuse.

---

## Image Upload Workflow

### Method 1: Direct File Upload (Legacy)
```
1. POST /api/posts/ with multipart/form-data
2. Include image files in 'images' field
3. Server processes and stores images
```

### Method 2: Supabase Storage (Recommended)
```
1. POST /api/storage/upload-url with filename
2. Receive signed upload URL and public URL
3. PUT image to signed upload URL
4. POST /api/posts/ with public URL in 'image_urls' array
```

**Example Flutter/Client Flow:**
```dart
// Step 1: Get upload URL
final response = await http.post(
  '/api/storage/upload-url',
  body: {'filename': 'image.jpg'}
);
final uploadData = response.data;

// Step 2: Upload to Supabase
await http.put(
  uploadData['upload_url'],
  body: imageBytes,
  headers: {'Content-Type': 'image/jpeg'}
);

// Step 3: Create post with public URL
await http.post(
  '/api/posts/',
  body: {
    'category': 'PROBLEM',
    'description': 'Issue description',
    'image_urls': [uploadData['public_url']]
  }
);
```

---

## Notes

1. **Authentication Token:** JWT token expires after a certain period (configured in Django settings). Implement token refresh mechanism if needed.

2. **Image Processing:** Uploaded images are automatically resized to max 1080x1080 and compressed to 85% JPEG quality.

3. **Locality Filtering:** Posts are filtered by pincode by default. Users can only see posts from their locality unless they explicitly filter by other pincodes/local bodies.

4. **Advertisements:** Only admin-approved advertisements (`is_ad_approved=True`) are shown in the feed.

5. **Cascade Deletion:** Deleting a user or post will automatically delete all related data (comments, votes, reports, images).

6. **Timezone:** All timestamps are in UTC. Client should convert to local timezone for display.

7. **File Size Limits:** Configure max upload size in Django settings (currently limited by server configuration).

---

## Support

For API issues or questions, contact the development team or refer to the backend source code:
- `basic/views.py` - API view implementations
- `basic/serializers.py` - Request/response serializers
- `basic/models.py` - Database models
